/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

#include <boost/test/unit_test.hpp>
#include "gto_d1_kit/gto_d1.hpp"
#include <armadillo>

using namespace boost::unit_test; 

BOOST_AUTO_TEST_SUITE(gto_d1_kit_overlap_test)

const double ae = 1.1;
const double be = 1.7;
const double cc = ae * be / (ae + be);
const double xAB = 1.1;
const double yAB = 2.3;
const double zAB = 1.6;

#define CHECK_GRADIENT(grad, ref_grad)                                       \
    for (unsigned i = 0; i < grad.n_rows; ++i)                               \
        for (unsigned j = 0; j < grad.n_cols; ++j)                           \
            for (int k = 0; k < 3; ++k)                                      \
                BOOST_CHECK_CLOSE(grad(i, j, k), ref_grad(i, j, k), 1e-5)

#define GENERATE_TEST_CASE(m, n, d)                                          \
    arma::cube grad(2 * m + 1, 2 * n + 1, 3, arma::fill::zeros);             \
    arma::cube ref_grad(2 * m + 1, 2 * n + 1, 3, arma::fill::zeros);         \
    unsigned index = 0;                                                      \
            for(unsigned k = 0; k < 3; ++k)                            \
                for(unsigned j = 0; j < 2 * n + 1; ++j)                \
                    for(unsigned i = 0; i < 2 * m + 1; ++i, ++index)            \
                ref_grad(i, j, k) = d[index];                                \
    overlap_gradient_##m##n(ae, be, cc, xAB, yAB, zAB,                       \
                            grad.slice(0).begin(),                           \
                            grad.slice(1).begin(),                           \
                            grad.slice(2).begin(),                           \
                            2 * n + 1, 0, 0);                                \
    CHECK_GRADIENT(grad, ref_grad)


BOOST_AUTO_TEST_CASE(overlap_ss)
{
    const double data[] = {-1.1662122345883617, -2.4384437632302101, -1.6963087048557985};
    GENERATE_TEST_CASE(0, 0, data);
}

BOOST_AUTO_TEST_CASE(overlap_sp)
{
    const double data[] = {
        -0.19214883399147822, -1.0537560548244838, -0.73304769031268457,
        -1.0537560548244838,  -1.8914866615345189, -1.532736079744704,
        -0.73304769031268457, -1.532736079744704,  -0.75442973281086689
    };

    GENERATE_TEST_CASE(0, 1, data);
}

BOOST_AUTO_TEST_CASE(overlap_sd)
{
    const double data[] = {
        -0.30071900143340913, -1.1472428161790147, -0.010558735770391618, -0.2091958270841108,  0.86936785599429256,
        -1.4157652534057552,  -2.059294914044735,  -0.022077356610818791, -1.1472428161790149,  0.84174828406328484,
        -1.1472428161790147,  -1.1807063888434488,  0.57264800757944467,  -0.56468566422947564, 0.92504954348031188
    };
    
    GENERATE_TEST_CASE(0, 2, data);
}

BOOST_AUTO_TEST_CASE(overlap_sf)
{
    const double data[] = {
         0.79097765721691016, -0.42266910986517475, 2.4398948804253795, 0.55934651803516278, -0.13923864436919819, 1.7280576025298038, -0.47112251378423298,
        -0.019424993359731798,-1.9898983322727051,  4.3354713751564837, 1.1695427195280677,  -0.52159647657529329, 1.6731576991978474, -2.5110503808777342,
         0.31044508247994562, -1.1409175334914017,  2.8982242311633328, 1.0835790176935001,   0.15583517165844898, 1.3010047987360123, -2.1485892479232573
    };

    GENERATE_TEST_CASE(0, 3, data);
}

BOOST_AUTO_TEST_CASE(overlap_ps)
{
    const double data[] = {
        0.2969572888959209,
        1.628532084728748,
        1.132891885028694,

        1.628532084728748,
        2.923206658735166,
        2.368773941423633,

        1.132891885028694,
        2.368773941423633,
        1.165936859798612
    };

    GENERATE_TEST_CASE(1, 0, data);
}

BOOST_AUTO_TEST_CASE(overlap_pp)
{
    const double data[] = {
        -0.28817639822296326, 0.26832212175238579, 0.18665886730600759,
         0.26832212175238568, 1.2632428775248392,  1.0236487389723561,
         0.18665886730600748, 1.0236487389723556,  0.50385128584154326,
        
         0.26832212175238573, 1.2632428775248397,  1.0236487389723559,
         1.2632428775248399,  1.7704532440606287,  1.8374441854906762,
         1.0236487389723559,  1.837444185490676,   1.0535072340323177,
        
         0.1866588673060075,  1.0236487389723559,  0.50385128584154326,
         1.0236487389723559,  1.8374441854906753,  1.0535072340323177,
         0.50385128584154337, 1.0535072340323179,  0.12705006013919995
    };

    GENERATE_TEST_CASE(1, 1, data);
}

BOOST_AUTO_TEST_CASE(overlap_pd)
{
    const double data[] = {
        -0.45100517609245211, 0.2921270299638834,   0.092683307272299023, -0.31374273119474938,  -0.37724599932908592,
         0.36050197287873242, 1.3753148175941621,   0.20291524438374067,   0.29212702996388323,  -0.88808885859571896,
         0.29212702996388323, 0.78854319540616047, -0.25154568893472118,   0.14378817075878658,  -0.84452877439445584,

         0.36050197287873254, 1.3753148175941623,   0.2029152443837404,    0.29212702996388334,  -0.88808885859571907,
         1.3251725410989863,  1.9275236961439808,   0.41991421521129535,   1.3753148175941625,   -0.32761622383823824,
         1.3753148175941625,  1.4154309522833455,  -0.52595916777259866,   0.78854319540616069,  -0.81769833309004825, 
         
         0.29212702996388329, 0.78854319540616047, -0.25154568893472129,   0.14378817075878658,  -0.84452877439445584,
         1.3753148175941623,  1.4154309522833453,  -0.52595916777259877,   0.78854319540616047,  -0.81769833309004791,
         0.78854319540616069, 0.19883736176514732, -0.77440653783960378,   0.095096129539853094, -0.63582139076227939
    };

    GENERATE_TEST_CASE(1, 2, data);
}

BOOST_AUTO_TEST_CASE(overlap_pf)
{
    const double data[] = {
        -0.58712847086132336, -0.63390060293810557, -0.52168806788563071, 0.027275637752486079, -0.095012805579172077, -0.74985843181308032, -0.85349853395099373,
        -0.67938988427613445,  0.50669577663862542, -2.7167081663988837, -0.426251236570449,     0.23240832930577507,  -1.7652696648913402,   0.51082592053842291,
        -0.76837829558214144,  0.29051639791706985, -1.7907384731362737, -0.54902165453972518,   0.029600548867861697, -1.187759072907661,    0.45766187053325491,

        -0.67938988427613456,  0.50669577663862564, -2.7167081663988837, -0.42625123657044961,   0.23240832930577507,  -1.7652696648913409,   0.51082592053842302,
         0.5269671368985902,   1.8625676983970374,  -3.6639477525320649, -0.66011766074847611,   0.83352800681636341,  -0.65120846418721323,  2.2037448186074102,
         0.018869993549453644, 1.3677320679939344,  -3.17149976573487,   -1.1479543685830611,   -0.072751404889524626, -1.15002430168891,     2.4393060842812275,

        -0.76837829558214144,  0.2905163979170699,  -1.7907384731362737, -0.54902165453972507,   0.029600548867861624, -1.1877590729076606,   0.45766187053325508,
         0.018869993549453644, 1.367732067993934,   -3.1714997657348687, -1.1479543685830611,   -0.072751404889524626, -1.1500243016889098,   2.4393060842812266,
        -0.21338059727598879,  0.19213670265072871, -1.1492293952636468, -0.40970787248034846,  -0.51020364346117664,  -0.21909626666614479,  1.4768063109914078
    };

    GENERATE_TEST_CASE(1, 3, data);
}

BOOST_AUTO_TEST_CASE(overlap_ds)
{
    const double data[] = {
        -0.7182462100351678,
        -2.740108875006076,
        -0.02521879865820789,
        -0.4996495374157689,
         2.076424052746699,

        -3.381455853175729,
        -4.918481240982879,
        -0.05273021537625304,
        -2.740108875006076,
         2.01045664540735,

        -2.740108875006076,
        -2.820034267568237,
         1.367729538764129,
        -1.348712041010896,
         2.209415851783556
    };

    GENERATE_TEST_CASE(2, 0, data);
}

//FIXME: !!!!!!!
BOOST_AUTO_TEST_CASE(overlap_dp)
{
   const double data[] = {
       0.6970079994156078, -1.218657665627703, -0.4514690463078198,
      -0.5571394126307685, -0.1432378385117349, -0.2222180820817611,
      -0.4514690463078199, -0.3135962867748713, 0.5830165444176781,
      -0.4514690463078195, 0.3887524283536603, 1.372500963284293,
      -2.125486536281887, 0.484875130028249, 1.305180833155068,

      -0.5571394126307685, -2.187484198983352, -2.125486536281887,
      -2.047993927152979, -0.3135962867748715, -1.218657665627703,
      -2.125486536281887, -0.648958332599275, 1.372500963284293,
      -2.125486536281888, 0.8128459865576528, 0.5063159822954582,
      -2.97890025767706, -0.4514690463078196, 1.26371560568462,

      -0.4514690463078196, -0.3072941045461368, -1.218657665627703,
      -2.125486536281887, 0.3887524283536603, -0.1469667456525002,
      -1.218657665627703, 0.8128459865576529, 1.305180833155068,
      -1.218657665627703, 1.196810103933934, 1.26371560568462,
      -2.187484198983352, -0.2222180820817611, 0.9826330584507961
   };

   GENERATE_TEST_CASE(2, 1, data);
}

BOOST_AUTO_TEST_CASE(overlap_dd)
{
    const double data[] = {
         0.93645934692431287, -0.60656751230464589, -0.30716238032951587, 0.75884491148385635, 0.76869533468950013,
        -0.60656751230464556, -1.6373174520735223, 0.2918006249671643, -0.3477783255611025, 1.4942660240172481,
        -0.30716238032951576, 0.29180062496716525, 0.68253602253271972, -0.040480333768428065, 0.43423425605872612,
         0.75884491148385635, -0.34777832556110266, -0.04048033376842803, 0.37351189900286541, 0.63474040242464091,
         0.76869533468950013, 1.4942660240172492, 0.4342342560587264, 0.6347404024246408, -0.80241253747500529,

        -0.5844528113460864, -2.2296871365506421, -0.87645545571263828, -0.60656751230464589, 1.0557114191326122,
        -2.2296871365506417, -2.2947241944957262, 0.43009142507190079, -1.6373174520735227, 0.55123514664106721,
        -0.8764554557126385, 0.43009142507190062, 1.4271207743865959, 0.2918006249671648, 0.61748194621957331,
        -0.60656751230464578, -1.6373174520735223, 0.29180062496716475, -0.34777832556110261, 1.4942660240172483,
         1.0557114191326114, 0.55123514664106643, 0.61748194621957331, 1.4942660240172483, 0.86473250383100331,

        -0.60656751230464578, -1.6373174520735223, 0.29180062496716475, -0.34777832556110255, 1.4942660240172481,
        -1.6373174520735225, -0.41286245882147743, 1.5472013632255348, -0.23000760440991164, 0.97347293446731087,
         0.29180062496716508, 1.5472013632255357, 0.36911267177968837, 0.73996586936873465, -0.2352858794201646,
        -0.34777832556110261, -0.23000760440991164, 0.73996586936873421, -0.041941104674268335, 1.0054146755381939,
         1.4942660240172487, 0.97347293446731165, -0.2352858794201646, 1.0054146755381939, 0.041752627891787054
    };

    GENERATE_TEST_CASE(2, 2, data);
}

BOOST_AUTO_TEST_CASE(overlap_df)
{
    const double data[] = {
         1.1005370180604495, 1.316220247815203, 0.99138295499834661, -0.22246780549813225, 0.32844290504619744, 1.5279490816003933, 1.6823254824902161,
         1.143116717779902, -0.60322322378059301, 3.3678845504409258, 0.90547671476908442, -0.13548388937300476, 2.1015601613298855, -0.85949712110438514,
         0.51258451273825212, -0.19843407036397734, -0.0012131816779517946, 0.35142402601067496, 0.13387199771650571, -0.090663046835614935, -0.55898188415094763,
         0.98788101804197703, 0.75466104690566815, 0.62221545977011306, 0.040106394977208186, -0.11460262281897522, 0.89270927738548844, 1.436065601417567,
        -0.48596172203927346, 1.0804231569073957, -2.7894673893183239, -0.21251748163138715, 0.48507651428591991, -1.5949693517976316, 1.1283078042595633,

         0.51289654751359348, -0.8214650499381605, 3.9484962551215954, 0.026823562795652171, -0.57440976106369734, 2.0984559428219933, -0.70497095493133943,
        -0.8866557448838206, -2.2173938353900469, 4.4785933008885976, 1.5003218085178662, -0.1993140832726932, 0.77526612068128775, -3.7079409072377025,
         0.11201585146457982, -0.13356256395392757, 0.18394329106570745, 0.7347956907495935, 1.039779263964518, 0.30388346760940349, -1.6406009085010045,
         1.1431167177799022, -0.60322322378059323, 3.3678845504409267, 0.90547671476908465, -0.13548388937300476, 2.1015601613298855, -0.85949712110438548,
         1.3170189621922497, 1.4838324271906407, -0.71566416925595155, 0.16580129752204267, 1.0678292986884186, 1.7188438324427853, 1.7447244023789317,

         1.143116717779902, -0.60322322378059312, 3.3678845504409258, 0.90547671476908442, -0.13548388937300462, 2.1015601613298855, -0.85949712110438548,
        -0.022464798142058668, -0.39894932613280826, 2.0256462500915324, 0.88443436654079, 1.061564120200895, 0.3354468546373065, -2.9040030483561132,
         0.0067132309174030482, 1.180198317082914, -2.0561796378096675, -1.0596213589298902, 0.54826422308171929, -1.3457972455610514, 0.40713171455494962,
         0.9147572447099096, -0.084739784853870848, 1.1569275734982467, 0.42299034921516049, 0.14253985497795546, 0.34645358753608002, -0.54484817453179757,
         0.93726838146289848, 1.4860274411478571, -1.9281889205592424, -0.7301077067703291, 0.042355730226858956, 0.058721578352100727, 2.572003254327635
    };

    GENERATE_TEST_CASE(2, 3, data);
}

BOOST_AUTO_TEST_CASE(overlap_fs)
{
    const double data[] = {
         -2.919664335016289,
          1.560160283071078,
         -7.028110899239582,
         -2.064665246511462,
          0.5139590231298803,
         -6.378622840893258,
          1.389774242581193,

          0.07170172229628988,
          7.345131860597895,
        -12.45253955415703,
         -4.317027333614871,
          1.925321930439079,
         -6.17597578975133,
          7.35357217070004,

         -1.145917873947389,
          4.211365771632798,
         -7.820785812068022,
         -3.999717290704859,
         -0.575220284265936,
         -4.802281424635634,
          6.598551629480001
    };

    GENERATE_TEST_CASE(3, 0, data);
}

// FIXME: !!!!!!!!
BOOST_AUTO_TEST_CASE(overlap_fp)
{
   const double data[] = {
-1.402315108090268, -4.954302742320804, 0.07069883159348773,
-1.622675012857876, -3.03370573187471, -1.790984188380001,
-1.835217582010239, 0.06514594471461563, -4.216222588046261,
-1.51402705991002, -1.018071135279834, -2.836879108019124,
1.210207268169941, -1.311299654231244, -1.6996103795774,
0.6938780082482084, -0.2269314116725679, 0.9045106092976001,
-0.9201050786718173, 0.5550909683418926, 0.8735723810510355,

-1.622675012857875, -6.600648568574742, -0.1737616199427491,
1.258623988129692, -5.34310240644312, -4.21622258804626,
0.04506965401481063, -1.018071135279834, -1.555365670662018,
1.210207268169941, -1.576644660795945, -2.746752257752852,
4.448612106088792, -2.741808367938055, 0.9045106092975999,
3.266731964051627, 0.5550909683418924, 3.777848261852713,
-4.954302742320807, 1.99082309066057, 4.622245364440026,

-1.835217582010239, -5.343102406443117, -1.218585561655207,
0.04506965401481004, -1.465239548831334, -2.836879108019124,
-0.5096445670476097, -1.311299654231245, -2.746752257752852,
0.6938780082482082, -2.741808367938055, -0.5232960418720322,
3.266731964051627, -0.9785584722877746, 0.8735723810510352,
0.4589050170748809, 0.07069883159348773, 4.622245364440026,
-3.03370573187471, -0.1737616199427491, 2.934691974707808
   };

   GENERATE_TEST_CASE(3, 1, data);
}

// FIXME: !!!!!!
BOOST_AUTO_TEST_CASE(overlap_fd)
{
   const double data[] = {
0.3048189006116795, -2.390564853162706, 2.333401698237385, -0.04362129884869218, -1.219868972183234, 1.492838871664558, -1.734312249943419,
-2.390564853162707, -2.02294330350895, -0.8529700182859843, 0.1152923520800667, 0.1435907533430203, -2.348356491139571, -2.908813172740995,
3.158604286444843, -1.468414369156003, 7.547677539872625, 1.713378475903323, -0.5736322030958514, 6.182410964344347, -1.452947356175992,
-0.04362129884869324, 0.1152923520800664, 1.195643914666315, 0.3925512569610307, -0.2834673833898526, 1.388464566007058, 0.7331885751562824,
-1.219868972183234, 0.14359075334302, -0.291343697919717, -0.2834673833898524, 0.6983639019458798, -0.4763176582622713, -0.9610056859690711,
1.492838871664556, -2.348356491139571, 4.038273805304195, 1.388464566007059, -0.4763176582622712, 3.466749677213442, -2.584205296732441,
-2.424806845955082, -3.654314306581735, -1.446019607059481, 0.7652661891804061, -1.072745845168097, -3.466079061397836, -3.611508821422665,

-1.623383645765167, -1.114103787217764, -2.047925045748597, -0.3620604202570505, -1.401785192503371, -4.045785938097018, -0.6792448247856869,
-1.114103787217763, 1.262537348591495, -3.796353337165931, -1.108165960720966, 0.5626734029067261, -3.225187733045963, 0.9354226048190357,
-2.687991457294178, -6.058670926816913, 9.261772570320652, 2.594152436007186, -1.743571939249843, 1.318039948862965, -7.040643852072844,
-0.3620604202570505, -1.108165960720968, 1.792358334007147, 0.8207889918276101, -1.223004856121603, 0.5367326984139877, 0.6786572529407203,
-1.40178519250337, 0.562673402906726, -0.7311496402320623, -1.223004856121603, -0.2125973859960112, -0.893664653533135, 1.089102428009046,
-4.045785938097019, -3.225187733045965, 0.5270671620331359, 0.5367326984139869, -0.8936646535331341, -3.735997368592315, -3.283613894962676,
-1.478243795129373, 1.53132403517829, -7.558919304449569, 0.1773629195839889, 1.362427097852284, -5.359665772199423, 0.6130396197675263,

-2.143861814768628, -1.756894648293431, -0.1960723678417628, 0.2020092895963403, -0.1993580845625974, -2.037202066131697, -2.135415688136026,
-1.756894648293431, 0.2271533438936792, -0.9014781453987163, -1.161717043669693, -0.3468881146644612, -0.7913760598405886, 0.9793272443388334,
-0.218992296261152, -2.562756990734304, 6.021506600055202, 2.525001591926847, 1.529448731695269, 1.993556876831681, -7.023184144552543,
0.20200928959634, -1.161717043669692, 1.130669798028986, 2.047771129120167, 0.7617366237399809, 1.324722781639216, -1.687743236033979,
-0.199358084562598, -0.3468881146644608, 1.441083201091985, 0.7617366237399807, -0.3372250134145764, 2.177504123234367, 0.3857415417346277,
-2.037202066131698, -0.7913760598405882, 0.5967108945481872, 1.324722781639216, 2.177504123234368, -0.03127186619650184, -4.193515769422914,
-3.039069806652511, 1.320990121835182, -6.166351401732719, -2.333422170657819, 0.4205533760206628, -5.590384192450344, 1.23651402838082 };

   GENERATE_TEST_CASE(3, 2, data);
}

BOOST_AUTO_TEST_CASE(overlap_ff)
{
    const double data[] = {
        0.30481890061167949, -2.3905648531627066, 3.1586042864448434, -0.043621298848693237, -1.2198689721832341, 1.4928388716645555, -2.4248068459550822,
        -2.3905648531627057, -2.0229433035089501, -1.468414369156003, 0.11529235208006641, 0.14359075334302002, -2.3483564911395711, -3.6543143065817354,
        2.3334016982373846, -0.85297001828598429, 7.547677539872625, 1.1956439146663154, -0.29134369791971704, 4.0382738053041951, -1.4460196070594811,
        -0.043621298848692182, 0.1152923520800667, 1.7133784759033228, 0.39255125696103071, -0.28346738338985239, 1.3884645660070587, 0.76526618918040612,
        -1.2198689721832339, 0.14359075334302032, -0.57363220309585139, -0.28346738338985256, 0.69836390194587983, -0.47631765826227118, -1.0727458451680969,
        1.4928388716645578, -2.3483564911395711, 6.1824109643443474, 1.388464566007058, -0.47631765826227135, 3.4667496772134418, -3.4660790613978358,
        -1.7343122499434194, -2.9088131727409947, -1.4529473561759918, 0.73318857515628244, -0.9610056859690711, -2.5842052967324407, -3.6115088214226652,
        
        -1.6233836457651671, -1.1141037872177633, -2.6879914572941783, -0.36206042025705054, -1.4017851925033704, -4.0457859380970191, -1.4782437951293734,
        -1.1141037872177642, 1.262537348591495, -6.0586709268169132, -1.1081659607209675, 0.56267340290672596, -3.2251877330459648, 1.53132403517829,
        -2.0479250457485971, -3.7963533371659306, 9.2617725703206517, 1.7923583340071472, -0.7311496402320623, 0.52706716203313586, -7.5589193044495691,
        -0.36206042025705054, -1.1081659607209664, 2.5941524360071857, 0.82078899182761011, -1.2230048561216034, 0.53673269841398685, 0.17736291958398895,
        -1.4017851925033706, 0.56267340290672607, -1.7435719392498428, -1.2230048561216029, -0.21259738599601119, -0.89366465353313407, 1.3624270978522841,
        -4.0457859380970183, -3.2251877330459626, 1.3180399488629646, 0.53673269841398774, -0.89366465353313496, -3.7359973685923147, -5.3596657721994232,
        
        -0.67924482478568693, 0.93542260481903572, -7.0406438520728436, 0.67865725294072032, 1.0891024280090456, -3.2836138949626763, 0.6130396197675263,
        -2.1438618147686284, -1.7568946482934311, -0.21899229626115199, 0.20200928959633996, -0.19935808456259799, -2.0372020661316981, -3.0390698066525115,
        -1.7568946482934309, 0.22715334389367917, -2.5627569907343037, -1.1617170436696918, -0.34688811466446079, -0.79137605984058823, 1.3209901218351821,
        -0.1960723678417628, -0.90147814539871629, 6.0215066000552016, 1.1306697980289864, 1.4410832010919845, 0.59671089454818715, -6.1663514017327188,
        0.20200928959634026, -1.1617170436696926, 2.5250015919268471, 2.047771129120167, 0.76173662373998074, 1.3247227816392164, -2.3334221706578187,
        -0.19935808456259738, -0.34688811466446123, 1.5294487316952694, 0.76173662373998086, -0.33722501341457639, 2.1775041232343684, 0.42055337602066284,
        -2.0372020661316972, -0.79137605984058856, 1.9935568768316807, 1.3247227816392164, 2.177504123234367, -0.031271866196501838, -5.5903841924503439,
        -2.135415688136026, 0.97932724433883345, -7.0231841445525429, -1.687743236033979, 0.38574154173462766, -4.1935157694229144, 1.2365140283808205
    };

    GENERATE_TEST_CASE(3, 3, data);
}

BOOST_AUTO_TEST_SUITE_END()
